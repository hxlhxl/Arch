ref: http://www.jianshu.com/p/71113f0c451c

# OSI七层模型

应用层
表示层
会话层
传输层
网络层
数据链路层
物理层

# TCP/IP四层模型

应用层【数据段】
传输层【数据包】
数据链路层【数据帧】
网络接口层【比特】

# IP

IP地址=网络地址(主机号)+主机地址(网络号)

一台网络设备的IP地址为192.168.100.1，那么
    网络地址： 192.168.100.0
    主机地址： 0.0.0.1
    IP地址： 网络地址+主机地址=192.168.100.1
    广播地址： 192.168.100.255
    因此192.168.100这个网络中还剩下254台主机可以分配主机地址(.0和.255代表网络地址和广播地址)

# 子网掩码

判断任意两台计算机IP是否处于同一网络的依据。
网络地址 = IP地址 & 子网掩码

255.255.255.0 & 192.168.100.1 = 11111111 11111111 11111111 00000000 &
				11000000 10101000 01000100 00000001
			      = 192.168.100.0(网络地址)

如何对192.168.100.0网段内的计算机子网划分？子网掩码
255.255.255.128 

11000000 10101000 01000100 10000000
那么就表示共有2^1个网段（子网），每个网段2^7台主机，一共也就是默认的2^8台主机啊。


2. 网络地址划分

A类地址
	0~127.x.x.x
	0保留表示所有IP，127保留表示测试回环
	子网掩码为：255.0.0.0
B类地址
	128~191.x.x.x
	子网掩码为：255.255.0.0
C类地址
	192～223.x.x.x
	子网掩码为：255.255.255.0
D类地址
	224~239.x.x.x
	子网掩码为： 
E类地址
	240~254.x.x.x



私有网络
	10.0.0.0~10.255.255.255
	172.16.0.0~172.31.255.255
	192.168.0.0~192.168.255.255



# 网络设备

## 两台计算机相连

     ---                   ---
    | A | <- - - - - - -> | B |
     ---                   ---
连接两台计算机的介质可以为同轴电缆、光纤和无线网，要把这些介质上不同类型的信号转换为计算机能够理解的信号，必须要有一种设备做这种工作，这种设备也就是计算机上的网卡设备。

## 多台计算机相连

     ---          ---
    | A |        | B |
     ---          ---
     |             |
    ----------------------------------------------
        |            |
       ---          ---
      | C |        | D |
       ---          ---


当计算机A要发送信号的时候，首先需要知道目标计算机是在什么位置，而这种形式首先就是通过广播的形式实现的：
    A： 请问谁是计算机B呀？
    B： 我是
    C： 我不是
    D： 我不是
当B回答了A的请求之后，二者就可以通信了。
而这种在一根线路上广播的形式，存在冲突的可能，即A发信号的同时，其他计算机必须用一种机制检测该线路上是否由其他的信号，如果有就不能发送信号了。当出现没有信号的空隙，才可以有机会发送信号。
这种冲突检测机制，就叫做CSMA/CD(Carrier Sense Multiple Access with Collision Detection载波侦听多路访问、冲突检测)。




CSMA/CD
CSMA/CD是一种争用型的介质访问控制协议。它起源于美国夏威夷大学开发的ALOHA网所采用的争用型协议，并进行了改进，使之具有比ALOHA协议更高的介质利用率。主要应用于现场总线Ethernet中。另一个改进是，对于每一个站而言，一旦它检测到有冲突，它就放弃它当前的传送任务。换句话说，如果两个站都检测到信道是空闲的，并且同时开始传送数据，则它们几乎立刻就会检测到有冲突发生。它们不应该再继续传送它们的帧，因为这样只会产生垃圾而已；相反一旦检测到冲突之后，它们应该立即停止传送数据。快速地终止被损坏的帧可以节省时间和带宽。
CSMA/CD应用在 OSI 的第二层数据链路层
它的工作原理是: 发送数据前 先侦听信道是否空闲 ,若空闲，则立即发送数据。若信道忙碌，则等待一段时间至信道中的信息传输结束后再发送数据；若在上一段信息发送结束后，同时有两个或两个以上的节点都提出发送请求，则判定为冲突。若侦听到冲突,则立即停止发送数据，等待一段随机时间,再重新尝试。


所谓载波侦听（carrier sense），意思是网络上各个工作站在发送数据前都要侦听总线上有没有数据传输。若有数据传输 （称总线为忙），则不发送数据；若无数据传输（称总线为空），立即发送准备好的数据。所谓多路访问（multiple access)意思是网络上所有工作站收发数据共同使用同一条总线，且发送数据是广播式的。所谓冲突（collision），意思是，若网上有两个或两个以上工作站同时发送数据，在总线上就会产生信号的混合，两个工作站都同时发送数据，在总线上就会产生信号的混合，两个工作站都辨别不出真正的数据是什么。这种情况称数据冲突又称碰撞。为了减少冲突发生后的影响。工作站在发送数据过程中还要不停地检测自己发送的数据，有没有在传输过程中与其它工作站的数据发生冲突，这就是冲突检测（collision detected）。


非常多台计算机连接

当网络中有非常多台计算机存在时，总线会出现一定程度的信号衰减，因此中继器的存在可以：
a、扩展网络距离，将衰减信号再生放大
b、实现不同粗细的同轴电缆的拼接
中继器虽然增大了网络容量，但是这些机器仍然是通过广播通信的，他们仍然在同一个广播域中。这样势必会带来广播风暴。


     ---          ---                     ---
    | A |        | B |                   | E |
     ---          ---                     ---
     |             |                       |       ...
   ----------------------------{Repeater}----------
        |            |
       ---          ---
      | C |        | D |                      ...
       ---          ---


集线器(HUB)
会出现非常大的冲突情形，因此必须要有一种设备具备将这种拓扑划分为CSMA/CD能够提供最大效率的容量。
HUB分为无源HUB、有源HUB和智能HUB，智能HUB具备路由器网络管理功能，具备了隔离广播冲突域的能力。


      {HUB} ----------------------- {HUB}
     /  |  \                        / | \
    A   B   C                      D  E  F

HUB的原理在于他将ABC划分在同一个广播域内，极大地减少了大容量网络中存在的广播问题。



网桥
网桥除了扩展网络的物理连接外，还能对MAC地址进行分类，隔离不同物理网段之间的碰撞，也就是隔离了冲突域。
网桥是二层网络设备，Repeater和HUB是一层网络设备，网桥具备隔离物理网段的能力，
网桥中存储这CAM(Content Addressable Memory,内容可寻址存储器)表，保存的是对应的MAC地址主机与所连接的交换机端口的映射。
这张表既可以是管理员生成的，也可以是网桥学习生成的。
A发送广播向D通信，Bridge发现不在左边网络中，就会发送到右边的网络中去了。如果发送对象是B，那么就会在左边网络中广播，这样就缩小了广播域，减少了冲突的存在。

    A                 D
      \             /
    B --  {Bridge} -- E
      /             \
    C                 F



交换机
网桥的极限情况下就是交换机，交换机的每个端口都是一个网桥，这个端口只连接一台计算机。





        A  B  C
        |  |  |
      ------------ D
        |  |  | 
      ---switch---- E
          ...
      ------------ F

这样在AD发送消息的时候，交换机内部还有不同的信道，提供给BC使用，这样，在同一时间就实现了“共用”信道的可能。
如果ABC、DEF主机采用单根同轴线缆的话，A、B之间通信的时候，BA之间是不可以通信的，这中情形成为半双工，所以才会用双绞线的存在，双绞线是一种4组8根铜线组成的线缆，其中只有两根真正发挥了作用。其余的是用来避免干扰的。
所以说，在交换机上连接的机器可以全双工的同时发送信息。
在这种情况下，交换机记录了端口和机器之间的映射表，但是在大量计算机连接的情况下，仍然会发生广播风暴的情况。
所以必须有一种网络设备，能够连接两个交换机，隔离两个交换机上的广播域。



## 路由器

集线器位于物理层，交换机位于数据链路层，路由器工作在网络层；此三层全部由物理设备实现，第四层传输层实现了隔离硬件和软件。5\6\7层全部由软件实现。
广播实际上就是A发送一个报文：mac A + FFFFFF，这种报文会在交换机的广播域内发送，那么广播域内的所有机器都会相应该报文，并发送自己的MAC地址给A，即mac B+mac A，同样，当发送指定对象的报文的时候，目标比较自己的MAC地址，如果匹配就会回应给源机器，不匹配的就会抛弃这些报文。

路由器的存在必须有逻辑地址的支持，这种表示计算机逻辑地址的东西就是我们所说的IP地址。

路由器上R1、R2的地址就是交换机域内主机的网关，Linux上查看网关的方法如下：
```
[husa@ArchLinux-husa sa]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    600    0        0 wlp3s0
192.168.1.0     0.0.0.0         255.255.255.0   U     600    0        0 wlp3s0
```
这里如果在浏览器输入192.168.1.1就会跳到路由器的设置界面，说明这个地址就是我们主机的网关地址了啊。
而192.168.1.0就代表了这个路由器所管辖的网络了呀，这就是这个网络的网络地址。
```
[husa@ArchLinux-husa sa]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: wlp3s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether a4:4e:31:3f:ea:c0 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.137/24 brd 192.168.1.255 scope global dynamic wlp3s0
       valid_lft 4726sec preferred_lft 4726sec
    inet6 fe80::dd66:59d6:7598:e630/64 scope link 
       valid_lft forever preferred_lft forever
3: enp0s25: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc fq_codel state DOWN group default qlen 1000
    link/ether 28:d2:44:21:e3:1e brd ff:ff:ff:ff:ff:ff
```
上面这个中本机的IP地址为：192.168.1.137/24，就表示这台机器所在网络为192.168.1.0，其在这个网络中的编号就是137号了啊。


        A  B  C
        |  |  |
      ------------ D
        |  |  | 
      ---switch---- E
        ...
      ------------ F
        |
        | R1(1.0 mac r1) 
      ---------- 
      |  Router|
      ----------
        | R2(2.0 mac r2)
        |
        A' B'  C'
        |  |  |
      ------------ D'
        |  |  | 
      ---switch---- E'
          ...
      ------------ F'



在以上这种拓扑中，主机见通信先通过逻辑地址广播，目标主机返回给源主机自己的逻辑地址+MAC地址，那么源主机和目标地址就可以通信了。这种完成逻辑地址与MAC地址转换的协议就是ARP协议(Address Resolution Protocol)，MAC地址到逻辑地址的转换就是RARP协议(Reverse Address Resolution Protocol)


两个交换机所管理的网络域中的机器使用逻辑地址+ARP协议进行通信，那么两个交换机之间的主机如何通信呢？交换机是如何判断逻辑地址位于哪个网络中的呢？这个问题的关键就在于子网掩码了。

```
[husa@ArchLinux-husa network]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    600    0        0 wlp3s0
192.168.1.0     0.0.0.0         255.255.255.0   U     600    0        0 wlp3s0

```
路由器具备学习的能力，这种能力是通过一些协议实现的，常见的有RIP、RIP2、OSPF协议

### 路由条目

- 主机路由：目标地址是主机

- 网络路由：目标地址是网络地址

- 默认路由：目标地址是0.0.0.0的叫做默认路由

  ​

  ​




4. 软件层
  端口
  表示双方主机进程所在的位置


一台主机可以有多个IP地址，因此PORT和IP地址这种绑定标示网络进程的方式就叫做套接字(socket)


5. 真实拓扑

  hosthost	host	host
   \        /
          \      /
           \    /
            switch
              |
        |
      router
        |
        |
      firewall
        |
      Internet
        ...


# 协议



```

HTTP SNMP DNS...
        |
TCP    UDP

    \     /

      IP

   /     \      \

Ethernet ppp ATM

```





## IP协议

## TCP/UDP协议

## HT协议

## TCP/IP协议栈

![TCP/IP协议栈](http://docs.linuxtone.org/ebooks/C&CPP/c/images/tcpip.stack.png)

## TCP传输过程

![TCP](https://www.polarxiong.com/usr/uploads/2017/04/3086068925.png)



- 数据传输过程中，客户发送了长为m的数据，服务器发送了长为n的数据。
- 客户主动关闭TCP连接
- 四次挥手过程中，服务器发送了长为k的数据；此次发送在实际中可能发生，也可能不发生。

## 网络协议栈封装

![网络协议栈数据封装](http://docs.linuxtone.org/ebooks/C&CPP/c/images/tcpip.datagram.png)



不同的协议层对数据包有不同的称谓，在传输层叫做段（segment），在网络层叫做数据报（datagram），在链路层叫做帧（frame）。数据封装成帧后发到传输介质上，到达目的主机后每层协议再剥掉相应的首部，最后将应用层数据交给应用程序处理。

## 跨路由器通信过程

![跨路由器通信过程](http://docs.linuxtone.org/ebooks/C&CPP/c/images/tcpip.transferovernet.png)



其实在链路层之下还有物理层，指的是电信号的传递方式，比如现在以太网通用的网线（双绞线）、早期以太网采用的的同轴电缆（现在主要用于有线电视）、光纤等都属于物理层的概念。物理层的能力决定了最大传输速率、传输距离、抗干扰性等。集线器（Hub）是工作在物理层的网络设备，用于双绞线的连接和信号中继（将已衰减的信号再次放大使之传得更远）。

链路层有以太网、令牌环网等标准，链路层负责网卡设备的驱动、帧同步（就是说从网线上检测到什么信号算作新帧的开始）、冲突检测（如果检测到冲突就自动重发）、数据差错校验等工作。交换机是工作在链路层的网络设备，可以在不同的链路层网络之间转发数据帧（比如十兆以太网和百兆以太网之间、以太网和令牌环网之间），由于不同链路层的帧格式不同，交换机要将进来的数据包拆掉链路层首部重新封装之后再转发。

网络层的IP协议是构成Internet的基础。Internet上的主机通过IP地址来标识，Internet上有大量路由器负责根据IP地址选择合适的路径转发数据包，数据包从Internet上的源主机到目的主机往往要经过十多个路由器。路由器是工作在第三层的网络设备，同时兼有交换机的功能，可以在不同的链路层接口之间转发数据包，因此路由器需要将进来的数据包拆掉网络层和链路层两层首部并重新封装。IP协议不保证传输的可靠性，数据包在传输过程中可能丢失，可靠性可以在上层协议或应用程序中提供支持。

网络层负责点到点（point-to-point）的传输（这里的“点”指主机或路由器），而传输层负责端到端（end-to-end）的传输（这里的“端”指源主机和目的主机）。传输层可选择TCP或UDP协议。TCP是一种面向连接的、可靠的协议，有点像打电话，双方拿起电话互通身份之后就建立了连接，然后说话就行了，这边说的话那边保证听得到，并且是按说话的顺序听到的，说完话挂机断开连接。也就是说TCP传输的双方需要首先建立连接，之后由TCP协议保证数据收发的可靠性，丢失的数据包自动重发，上层应用程序收到的总是可靠的数据流，通讯之后关闭连接。UDP协议不面向连接，也不保证可靠性，有点像寄信，写好信放到邮筒里，既不能保证信件在邮递过程中不会丢失，也不能保证信件是按顺序寄到目的地的。使用UDP协议的应用程序需要自己完成丢包重发、消息排序等工作。

## Multiplexing过程

![multiplexing](http://docs.linuxtone.org/ebooks/C&CPP/c/images/tcpip.multiplex.png)

以太网驱动程序首先根据以太网首部中的“上层协议”字段确定该数据帧的有效载荷（payload，指除去协议首部之外实际传输的数据）是IP、ARP还是RARP协议的数据报，然后交给相应的协议处理。假如是IP数据报，IP协议再根据IP首部中的“上层协议”字段确定该数据报的有效载荷是TCP、UDP、ICMP还是IGMP，然后交给相应的协议处理。假如是TCP段或UDP段，TCP或UDP协议再根据TCP首部或UDP首部的“端口号”字段确定应该将应用层数据交给哪个用户进程。IP地址是标识网络中不同主机的地址，而端口号就是同一台主机上标识不同进程的地址，IP地址和端口号合起来标识网络中唯一的进程。

注意，虽然IP、ARP和RARP数据报都需要以太网驱动程序来封装成帧，但是从功能上划分，ARP和RARP属于链路层，IP属于网络层。虽然ICMP、IGMP、TCP、UDP的数据都需要IP协议来封装成数据报，但是从功能上划分，ICMP、IGMP与IP同属于网络层，TCP和UDP属于传输层。本文对RARP、ICMP、IGMP协议不做进一步介绍，有兴趣的读者可以看参考资料。







# Linux网络操作

使用命令是使用用户空间的程序去修改内核空间的网络协议栈，其生效是发生在内存中的，如果要永久生效，需要使用配置文件，这样开机重启的时候能够默认配置网络。


1. 查看当前网络最大带宽
2. 网卡绑定
3. 逻辑IP
4. 回环网络
